#!/bin/sh

test=`echo $1 | cut -d. -f1`
ext=`echo $1 | cut -d. -f2`
case $ext in
    ctst) log=clog; out=cout; ref=cref; ;;
    *)    log=log;  out=out; ref=ref; ;;
esac
valgrind=$2
BASILISK_WIKI=`echo $BASILISK | sed 's:/src$::'`
dir=`echo $PWD | sed "s:$BASILISK_WIKI/::"`

script()
{
    rm -f $test.c
    if test -f fail; then
	return 1
    fi
    cat warn
    test -s warn || rm -f warn

    pass=true
    if test -n "$valgrind" -o -z `which gdb`; then
	if ! $valgrind ./$test 2> $log > $out; then
	    pass=false
	fi
    else
	if ! gdb -batch -return-child-result -ex "run 2> $log > $out" ./$test > gdb.log; then
	    pass=false
	    awk '
     {
       if (NF > 0)
         a[nb++] = $0;
     }
     / at .*:[0-9]*$/ {
       for (i = 0; i < nb - 1; i++)
	 print $(NF) ":error: " a[i];
     }
     ' < gdb.log >> $log
	fi
	rm -f gdb.log
    fi

    if $pass; then
	if test -f $test.$ref; then
	    ref=$ref
	else
	    ref=ref
	fi
	if test -f $test.$ref; then
            echo diff $log $test.$ref > fail
            diff $log $test.$ref >> fail && rm -f fail
            rm -f $test.$ref
	fi
    else
	cp -f $log fail
    fi
    if test -f fail; then
	return 1
    fi
    touch pass
}

expirecache()
{
    rm -f $BASILISK_WIKI/cache/$dir/$test.c.page
}

# run locally
locally()
{
    echo \[$test.$ext\]
    qcc $CFLAGS -o $test/$test $test.c $LIBS -lm > $test/warn 2>&1 \
	|| mv -f $test/warn $test/fail
    cd $test
    script
    expirecache
    cd ..
}

# compile/run on a remote "sandbox"
remotely()
{
    rhost=$1
    chksum=`$GENSUM $test.s | cut -d' ' -f1`.$ext
    cd $test
    mkdir $chksum
    qcc -source $CFLAGS $test.c
    mv -f _$test.c $chksum/$test.c
    cp -f $test.*ref $chksum 2> /dev/null || true
    PCFLAGS=`echo $CFLAGS | sed 's/-grid=[^-]*//'`
    cat <<EOF >$chksum/$test.sh
#!/bin/sh
\$CC99 $PCFLAGS -I\$HOME/include -o $test $test.c -L\$HOME/lib $LIBS -lm > warn 2>&1 || mv -f warn fail
rm -f $test.c
if ! test -f fail; then
  test -s warn || rm -f warn

  pass=true
  if test -n "$valgrind" -o -z `which gdb`; then
    if ! timeout 1h $valgrind ./$test 2> $log > $out; then
       pass=false
    fi
  else
    if ! timeout 1h gdb -batch -return-child-result -ex "run 2> $log > $out" ./$test > gdb.log; then
       pass=false
       awk '
       {
         if (NF > 0)
           a[nb++] = \$0;
       }
       / at .*:[0-9]*\$/ {
         for (i = 0; i < nb - 1; i++)
   	   print \$(NF) ":error: " a[i];
       }
       ' < gdb.log >> $log
    fi
    rm -f gdb.log
  fi

  if \$pass; then
    if test -f $test.$ref; then
      ref=$ref
    else
      ref=ref
    fi
    if test -f $test.\$ref; then
        echo diff $log $test.\$ref > fail
        diff $log $test.\$ref >> fail && rm -f fail
        rm -f $test.\$ref
    fi
  else
    cp -f $log fail
  fi
  if ! test -f fail; then
    touch pass
  fi
fi
rm -f $test $test.c $test.sh $test.*ref
tar czf \$HOME/$chksum.tgz *
rm -r -f \$HOME/$chksum
EOF
    tar czf $chksum.tgz $chksum
    rm -r -f $chksum
    scp -q $chksum.tgz $rhost: && rm -f $chksum.tgz
    ssh $rhost sh -c "\"tar xmzf $chksum.tgz && cd $chksum && tsp -n nice -19 sh $test.sh\" && sleep 0 && tsp -p && tsp -w" > tspid.$ext
    scp -q $rhost:$chksum.tgz $chksum.tgz
    ssh $rhost rm -r -f $chksum.tgz
    tar xmzf $chksum.tgz
    rm -f $chksum.tgz $test.c $test.*ref
    if test -f fail; then
	echo
	echo \[$test.$ext\]
	cat fail
	if test -n "$MAINTAINER"; then
	    (
		echo Latest change:
		echo
		darcs changes --last=1
		echo
		if test -f ../$test.c.page; then
		    cat <<EOF
See http://basilisk.fr/$dir/$test.c
EOF
		else
		    cat fail
		fi 
	    ) | mail -s "basilisk: $test.$ext failed" $MAINTAINER
	fi
    fi
    cd ..
    # generate graphics
    if test -f $test.plot -o -f $test.plot.page; then
	make $test/plot.png
    fi
    cd $test
    if ! sh $BASILISK/gnuplot.sh > .tmp; then
	cat .tmp >> warn
	rm -f .tmp
    fi
    # Complete
    rm -f *pid.$ext
    expirecache
}

checksum()
{
    if grep $1 $2 | $CHECKSUM; then 
	return 0;
    else
	return 1;
    fi
}

# check sum for test.c
source_modified=false
if ! test -f $test.$ext || ! test -f $test.s || \
    ! checksum $test.c $test.$ext; then
    echo qcc $CFLAGS -o $test/$test $test.c $LIBS -lm
    if ! qcc `echo " $CFLAGS " | sed -e 's/ -O[0-9] / /g' -e 's/ -g / /g'` \
	-nolineno -S $test.c; then
	rm -f $test.s
	exit 1
    fi
    if test -f $test.$ext; then
	sed "1s/.*/`$GENSUM $test.c`/" $test.$ext > $test.$ext.1
	mv -f $test.$ext.1 $test.$ext
    fi
    source_modified=true
fi

# check sum for test.s
if test -f $test.$ext && checksum $test.s $test.$ext; then
    touch $test.$ext
    echo "make: '$test.$ext' is up to date."
    if test -n "$SANDBOX" && $source_modified; then
	rm -f $test/warn && make $test/plots
    fi
else
    if test -n "$SANDBOX" -a -f $test/pid.$ext; then
	echo Killing `cat $test/pid.$ext`
	kill `cat $test/pid.$ext`
	ssh $SANDBOX kill `cat $test/tspid.$ext`
	rm -f $test/*pid.$ext
    fi

    rm -f $test.$ext $test/pass \
	$test/fail $test/warn $test/plot.png $test/plots
    $GENSUM $test.c $test.s > $test.$ext
    expirecache

    mkdir -p $test && cp -f $test.c $test
    awk -f $BASILISK/gnuplot.awk < $test.c > $test/plots
    cp -f $test.*ref $test 2> /dev/null || true
    if test -d $BASILISK_WIKI/static -a -f $test.c.page; then
	if test ! -L $BASILISK_WIKI/static/$dir/$test; then
	    mkdir -p $BASILISK_WIKI/static/$dir
	    ln -s $PWD/$test $BASILISK_WIKI/static/$dir/$test
	fi
    fi

    if test -n "$SANDBOX"; then
        ( remotely $SANDBOX ) &
	echo $! > $test/pid.$ext
    else
	locally
	rm -f $test/plots
    fi
fi

if test -f $test/warn; then
    cat $test/warn
fi
if test -f $test/fail; then
    cat $test/fail
    rm -f $test.$ext
    exit 1
elif test -f $test/pid.$ext; then
    echo \[$test.$ext on $SANDBOX \(`cat $test/pid.$ext`\)\]
    echo "  running..."
fi
